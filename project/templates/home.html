{% extends "_base.html" %}

{% block content %}
<div class="starter-template">
  <h1 style="display: inline-block;">FastAPI + Celery + Docker</h1>
  <div class="login_url" style="display: inline-block;"><a href="/login">Login</a><a href="/register">Register</a></div>
  <hr><br>
  <h1>File upload</h1>
  <p>Show a file-select field which allows a file to be chosen for upload:</p>
  <label for="fileInput">Select a file:</label>
  <input type="file" id="fileInput" multiple>
  <img id="imagePreview" style="max-width: 300px; max-height: 300px;" />
  <div class="btn-gr" role="group" aria-label="Basic example">
    <button type="button" class="btn btn-primary" onclick="handleUpload()">Chuyển</a>
  </div>

  <hr><br>
  <div>
    <h3>Tasks</h3>
    <p>Pick a task length.</p>
    <div class="btn-group" role="group" aria-label="Basic example">
      <button type="button" class="btn btn-primary" onclick="handleClick(1)">Short</a>
      <button type="button" class="btn btn-primary" onclick="handleClick(2)">Medium</a>
      <button type="button" class="btn btn-primary" onclick="handleClick(3)">Long</a>
    </div>
  </div>
  <br><br>
  <div>
    <h3>Task Status</h3>
    <br>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody id="tasks">
      </tbody>
    </table>
  </div>
</div>
<script>
  const fileInput = document.getElementById('fileInput');
  const imagePreview = document.getElementById('imagePreview');
  fileInput.addEventListener('change', function() {
      const selectedFile = fileInput.files[0];
  });
  async function handleUpload() {
      const selectedFile = fileInput.files[0];
      if (selectedFile) {
        try {
          const CLOUD_NAME = "dbaul3mwo";
          const PRESET_NAME = "ske802vb";
          const FORDER_NAME = "Image";
          const urls = [];
          const api = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`
          const formData = new FormData(); // Tạo đối tượng FormData
          formData.append("upload_preset", PRESET_NAME); // Thêm giá trị upload_preset và
          formData.append("forder", FORDER_NAME);

          for (const file of fileInput.files){
            formData.append("file", file);
            const response = await fetch(api, {
              method: 'POST',
              mode: 'cors',
              body: formData,
            })
            response.json().then((data)=>{urls.push(data.secure_url)})
            .catch((error) => {
              console.error("Error:", error);
            });
          }  

          const response =await fetch("https://serverltmnc.onrender.com/login/decoded", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "Authorization": sessionStorage.getItem("token")
              },
            })
              
          response.json().then((data) =>{localStorage.setItem('id', JSON.stringify(data.user._id));})
            .catch((error) => {
                console.error("Error:", error);
            });

          var id_user=JSON.parse(localStorage.getItem('id'));
          localStorage.removeItem('id');
          
          var ListProduct = [];
          for(const url of urls){
            product = {
              img_link:url,
              audio_link:"Padding",
              user_id:id_user
            }
            const response =await fetch("https://serverltmnc.onrender.com/product/addProduct", {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                  },
                  body: JSON.stringify(product),
              })
            response.json().then((data)=>{ListProduct.push(data)})
              .catch((error) => {
                console.error("Error:", error);
              });
          }
          ListProduct.forEach((product)=>{
            var data = {
              "id_product":product._id,
              "img_link":product.img_link,
              "user_id":product.user_id
            }
            console.log(data);
            fetch("http://157.245.62.82:8004/tasks_train_ai", {
              method: "POST",
              mode: "no-cors",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(data)
            })
              .then(response => response.json())
              .then(data => {
                console.log(data);
              })
              .catch(error => {
                console.error("Lỗi:", error);
              });        
          });
          var data = {
            "id_product":ListProduct[ListProduct.length-1]._id,
            "img_link":ListProduct[ListProduct.length-1].img_link,
            "user_id":ListProduct[ListProduct.length-1].user_id
          }
          fetch("http://157.245.62.82:8004/tasks_train_ai", {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          })
            .then(response => response.json())
            .then(data => {
              console.log(data);
            })
            .catch(error => {
              console.error("Lỗi:", error);
            });
        } catch (error) {
            console.log(error);
        }
      }
  }
</script>
{% endblock %}
